<!DOCTYPE html>
<html lang="lt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VolleyApp - Tinklinio Registracija</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sand: { 50: '#fefce8', 100: '#fef9c3', 300: '#fde047', 400: '#facc15', 500: '#eab308', 600: '#ca8a04', 900: '#713f12' },
                        ocean: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-ocean-50 via-white to-sand-50 min-h-screen text-gray-800">

    <!-- NAVIGACIJA -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-md mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div
                    class="w-8 h-8 bg-sand-500 rounded-lg flex items-center justify-center text-white font-bold text-lg">
                    V</div>
                <h1 class="text-xl font-bold tracking-tight">VolleyApp</h1>
            </div>

            <!-- Login / User Controls -->
            <div>
                <button id="btnLogin"
                    class="hidden text-sm font-medium text-white bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                    Prisijungti
                </button>
                <div id="userProfile" class="hidden flex items-center space-x-3">
                    <img id="userPhoto" class="w-8 h-8 rounded-full border border-gray-200" src="" alt="">
                    <button id="btnLogout"
                        class="text-sm text-gray-500 hover:text-red-500 font-medium">Atsijungti</button>
                </div>
            </div>
        </div>
    </header>

    <!-- PAGRINDINIS TURINYS -->
    <main class="max-w-md mx-auto px-4 py-6">

        <!-- Loading -->
        <div id="loading" class="text-center py-10">
            <div
                class="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent text-sand-500 rounded-full">
            </div>
        </div>

        <!-- Renginio Kortelƒó -->
        <div id="eventCard" class="hidden bg-white rounded-2xl shadow-xl overflow-hidden fade-in">

            <!-- Vir≈°us: Data -->
            <div class="bg-gradient-to-r from-sand-400 to-sand-500 p-6 text-center text-white">
                <h2 class="text-xs font-bold uppercase tracking-wider text-sand-900 opacity-70 mb-1">Artimiausias
                    ≈Ωaidimas</h2>
                <div id="displayDate" class="text-3xl font-extrabold">Kraunama...</div>
                <div class="mt-2 text-sand-100 text-sm font-medium">≈†e≈°tadienis, 10:00</div>
            </div>

            <!-- Statusas -->
            <div class="bg-sand-50 px-6 py-3 border-b border-sand-100 flex justify-between items-center">
                <span class="text-sm font-medium text-gray-600">U≈æsiregistravo:</span>
                <span id="playerCount" class="text-xl font-bold text-sand-600">0/24</span>
            </div>

            <!-- ≈Ωaidƒój≈≥ SƒÖra≈°as -->
            <div class="p-4 bg-white min-h-[200px]">
                <ul id="playersList" class="space-y-2">
                    <!-- ƒåia atsiras ≈æaidƒójai -->
                </ul>
                <div id="emptyListMsg" class="hidden text-center text-gray-400 py-8 text-sm">
                    SƒÖra≈°as tu≈°ƒçias. B≈´k pirmas! üèê
                </div>
            </div>

            <!-- Veiksm≈≥ Mygtukai -->
            <div class="p-4 border-t border-gray-100 bg-gray-50">
                <div id="authWarning" class="text-center text-sm text-gray-500 mb-2">Prisijunkite, kad galƒótumƒóte ≈æaisti
                </div>

                <button id="btnJoin"
                    class="hidden w-full bg-sand-500 hover:bg-sand-600 text-white font-bold py-3.5 rounded-xl shadow-lg transform transition active:scale-95">
                    DALYVAUTI ‚úã
                </button>

                <button id="btnLeave"
                    class="hidden w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3.5 rounded-xl transition">
                    NEBE≈ΩAISIU ‚ùå
                </button>
            </div>
        </div>
    </main>

    <!-- FIREBASE SDK (Modular style via CDN) -->
    <script type="module">
        // --------------------------------------------------------
        // 1. FIREBASE KONFIG≈™RACIJA
        // --------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, arrayUnion, arrayRemove, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ‚ö†Ô∏è SVARBU: ƒåia ƒØklijuokite savo konfig≈´racijƒÖ i≈° Firebase Console
        const firebaseConfig = {
            apiKey: "PAKEISTI_MANE",
            authDomain: "PAKEISTI_MANE.firebaseapp.com",
            projectId: "PAKEISTI_MANE",
            storageBucket: "PAKEISTI_MANE.appspot.com",
            messagingSenderId: "...",
            appId: "..."
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --------------------------------------------------------
        // 2. LOGIKA
        // --------------------------------------------------------

        let currentUser = null;
        let currentGameId = "next_saturday"; // Fiksuotas ID paprastumui

        // DOM Elementai
        const els = {
            loading: document.getElementById('loading'),
            eventCard: document.getElementById('eventCard'),
            displayDate: document.getElementById('displayDate'),
            playerCount: document.getElementById('playerCount'),
            playersList: document.getElementById('playersList'),
            emptyListMsg: document.getElementById('emptyListMsg'),
            btnJoin: document.getElementById('btnJoin'),
            btnLeave: document.getElementById('btnLeave'),
            btnLogin: document.getElementById('btnLogin'),
            btnLogout: document.getElementById('btnLogout'),
            userProfile: document.getElementById('userProfile'),
            userPhoto: document.getElementById('userPhoto'),
            authWarning: document.getElementById('authWarning')
        };

        // A. AUTENTIFIKACIJA
        els.btnLogin.onclick = () => signInWithPopup(auth, provider).catch(e => console.error(e));
        els.btnLogout.onclick = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                // Prisijungƒôs
                els.btnLogin.classList.add('hidden');
                els.userProfile.classList.remove('hidden');
                els.userPhoto.src = user.photoURL;
                els.authWarning.classList.add('hidden');
            } else {
                // Neprisijungƒôs
                els.btnLogin.classList.remove('hidden');
                els.userProfile.classList.add('hidden');
                els.authWarning.classList.remove('hidden');
                hideButtons();
            }
        });

        // B. DUOMEN≈≤ KLAUSYMAS (REAL-TIME)
        const gameRef = doc(db, "events", currentGameId);

        // U≈ætikriname, kad dokumentas egzistuoja (pirmam kartui)
        async function ensureGameExists() {
            const snap = await getDoc(gameRef);
            if (!snap.exists()) {
                // Sukuriame artimiausiƒÖ ≈°e≈°tadienƒØ
                const d = new Date();
                d.setDate(d.getDate() + (6 - d.getDay() + 7) % 7); // Kitas ≈°e≈°tadienis
                const dateStr = d.toISOString().split('T')[0];
                await setDoc(gameRef, {
                    date: dateStr,
                    maxPlayers: 24,
                    players: []
                });
            }
        }
        ensureGameExists();

        // Pagrindinis Listener
        onSnapshot(gameRef, (docSnap) => {
            if (!docSnap.exists()) return;
            const data = docSnap.data();

            els.loading.classList.add('hidden');
            els.eventCard.classList.remove('hidden');

            // Atnaujinam datƒÖ
            els.displayDate.innerText = data.date;

            // ≈Ωaidƒój≈≥ sƒÖra≈°o renderinimas
            renderPlayers(data.players || []);

            // Atnaujinam mygtuk≈≥ b≈´senƒÖ
            updateButtonState(data.players || []);
        });

        // C. RENDERINIMAS
        function renderPlayers(players) {
            els.playerCount.innerText = `${players.length}/24`;
            els.playersList.innerHTML = '';

            if (players.length === 0) {
                els.emptyListMsg.classList.remove('hidden');
            } else {
                els.emptyListMsg.classList.add('hidden');
                players.forEach((p, idx) => {
                    const isMe = currentUser && p.uid === currentUser.uid;
                    const li = document.createElement('li');
                    li.className = `flex items-center p-3 rounded-lg transition-all ${isMe ? 'bg-sand-50 border-l-4 border-sand-500 shadow-sm' : 'border-b border-gray-50'}`;
                    li.innerHTML = `
                        <span class="w-6 text-gray-400 font-mono text-xs mr-3">#${idx + 1}</span>
                        <img src="${p.photoURL}" class="w-8 h-8 rounded-full mr-3 border border-gray-200">
                        <span class="${isMe ? 'font-bold text-gray-900' : 'text-gray-700'}">${p.displayName}</span>
                    `;
                    els.playersList.appendChild(li);
                });
            }
        }

        // D. MYGTUK≈≤ VALDYMAS
        function updateButtonState(players) {
            if (!currentUser) return hideButtons();

            const amIn = players.some(p => p.uid === currentUser.uid);
            if (amIn) {
                els.btnJoin.classList.add('hidden');
                els.btnLeave.classList.remove('hidden');
            } else {
                els.btnJoin.classList.remove('hidden');
                els.btnLeave.classList.add('hidden');
            }
        }

        function hideButtons() {
            els.btnJoin.classList.add('hidden');
            els.btnLeave.classList.add('hidden');
        }

        // E. REGISTRACIJOS VEIKSMAI
        els.btnJoin.onclick = async () => {
            if (!currentUser) return;
            const playerObj = {
                uid: currentUser.uid,
                displayName: currentUser.displayName,
                photoURL: currentUser.photoURL
            };
            await updateDoc(gameRef, {
                players: arrayUnion(playerObj)
            });
        };

        els.btnLeave.onclick = async () => {
            if (!currentUser) return;
            // Reikia surasti tiksl≈≥ objektƒÖ masyve, kad i≈°trinti (Firebase limitation)
            // Paprastumo dƒólei nuskaitome, i≈°filtruojame ir ƒØra≈°ome
            const snap = await getDoc(gameRef);
            const currentPlayers = snap.data().players || [];
            const newPlayers = currentPlayers.filter(p => p.uid !== currentUser.uid);

            await updateDoc(gameRef, { players: newPlayers });
        };

    </script>
</body>

</html>